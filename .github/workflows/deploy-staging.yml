name: Deploy to Staging

on:
  push:
    branches:
      - feature/m2-arbitrum-sdk
      - feature/m3-full-dapp-builder
  workflow_dispatch:
    inputs:
      refresh_rag:
        description: 'Also refresh RAG data after deploy'
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Install dependencies
        run: |
          cd apps/web
          npm ci

      - name: Build
        run: |
          cd apps/web
          npm run build

      - name: Deploy to Cloudflare (Staging)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          cd apps/web
          npx wrangler deploy --env staging

      - name: Output staging URL
        run: |
          echo "## Staging Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://arbbuilder-staging.swmengappdev.workers.dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

  refresh-rag:
    name: Refresh RAG (Staging)
    runs-on: ubuntu-latest
    needs: deploy
    if: ${{ github.event.inputs.refresh_rag == 'true' || github.event_name == 'push' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install -e .
          pip install crawl4ai playwright
          playwright install chromium

      - name: Run web scraper
        run: python -m scraper.run --categories stylus arbitrum_sdk
        continue-on-error: true

      - name: Run GitHub scraper
        run: python -m scraper.github_scraper
        continue-on-error: true

      - name: Process data
        run: python -m src.preprocessing.processor

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install migration dependencies
        run: npm install tsx

      - name: Migrate to Staging Vectorize
        env:
          AUTH_SECRET: ${{ secrets.AUTH_SECRET_STAGING }}
          MIGRATE_URL: https://arbbuilder-staging.swmengappdev.workers.dev
        run: npx tsx scripts/diff-migrate.ts --full

      - name: Summary
        run: |
          echo "## RAG Refresh Complete (Staging)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f .rag-state/last-refresh.json ]; then
            echo "### Migration Details" >> $GITHUB_STEP_SUMMARY
            cat .rag-state/last-refresh.json >> $GITHUB_STEP_SUMMARY
          fi
